<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SVT life</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Noto+Sans+TC:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --rose-quartz: #F7CAC9; --serenity: #92A8D1; }
        
        body {
            background: linear-gradient(180deg, var(--rose-quartz) 0%, var(--serenity) 100%);
            background-attachment: fixed;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: 'Kiwi Maru', 'Noto Sans TC', sans-serif;
            color: #555;
        }

        .app-container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(10px); 
            height: 100vh; 
            overflow-y: auto; 
            position: relative; 
            padding-bottom: 110px; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .page-section { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-header { background-color: var(--serenity); color: white; padding: 6px 18px; border-radius: 50px; display: inline-block; font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(146, 168, 209, 0.3); }
        .svt-card { background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(146, 168, 209, 0.2); position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .bg-serenity { background-color: var(--serenity) !important; }
        .text-serenity { color: var(--serenity) !important; }

        .profile-header { height: 160px; background: linear-gradient(45deg, var(--rose-quartz), var(--serenity)); background-size: cover; background-position: center; position: relative; border-bottom: 4px solid white; cursor: pointer; }
        .profile-avatar-container { width: 90px; height: 90px; border-radius: 50%; border: 4px solid white; position: absolute; bottom: -45px; left: 20px; background: white; z-index: 10; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .profile-avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        
        #cropperModal { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: #000; z-index: 11000; display: none; flex-direction: column; 
        }
        .cropper-container-box { flex: 1; width: 100%; position: relative; overflow: hidden; background: #000; }
        .crop-controls { 
            height: 160px; background: rgba(26, 26, 26, 0.95); display: flex; justify-content: center; 
            align-items: flex-start; gap: 60px; padding-top: 25px; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid #333; 
        }
        .btn-fab { width: 65px; height: 65px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-fab-ok { background: var(--serenity); color: white; }
        .btn-fab-cancel { background: #444; color: white; }

        .member-avatar-sm { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 2px solid white; background: linear-gradient(135deg, var(--rose-quartz), var(--serenity)); overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; }
        .member-avatar-sm img { width: 100%; height: 100%; object-fit: cover; }
        
        .gem-rating { font-size: 0.85rem; color: #eee; cursor: pointer; margin: 0 2px; }
        .gem-rating.active { color: var(--serenity); }
        .reset-btn { font-size: 0.85rem; color: #ccc; cursor: pointer; margin-left: 10px; transition: 0.3s; }

        /* ÂÑ™ÂåñÔºöÂÅΩÈ†ÅÈù¢ÁñäÂä†Ê≥ï */
        .member-detail-modal { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; 
            min-height: 100%; 
            background: #fff; 
            z-index: 900; /* ‰ΩéÊñºÂ∞éË¶ΩÂàó 1000 */
            display: none; 
            overflow-y: auto; 
            padding: 25px 25px 90px 25px; /* Â∫ïÈÉ®ÁïôÁôΩÈÅøÈñãÂ∞éË¶ΩÂàó */
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }
        .modal-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--serenity); object-fit: cover; margin-right: 12px; background: linear-gradient(135deg, var(--rose-quartz), var(--serenity)); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .modal-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .sync-fin-item { font-size: 0.8rem; background: #f0f4f8; padding: 8px; border-left: 3px solid var(--serenity); margin-bottom: 8px; border-radius: 4px; }

        .calendar-nav { background: white; border-radius: 20px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(146,168,209,0.2); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cal-month { font-weight: bold; color: var(--serenity); font-size: 1.1rem; }
        .week-table { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-item { padding: 8px 0; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .day-item span { display: block; font-size: 0.7rem; color: #aaa; margin-bottom: 2px; }
        .day-item.active { background: var(--serenity); color: white; font-weight: bold; }
        .day-item.active span { color: #fff; }
        
        .diary-paper { background: #fff; background-image: linear-gradient(#f9f9f9 1px, transparent 1px); background-size: 100% 2.5rem; line-height: 2.5rem; padding: 1.5rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; margin-bottom: 20px; }
        .diary-paper::before { content: ''; position: absolute; left: 25px; top: 0; bottom: 0; width: 1.5px; background: rgba(247, 202, 201, 0.5); }
        .diary-content-text { margin-left: 25px; font-size: 0.95rem; color: #444; min-height: 5rem; white-space: pre-wrap; }
        .diary-thumb { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; margin-top: 15px; margin-left: 25px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: zoom-in; }
        .diary-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 15px; line-height: 1; z-index: 5; }
        .diary-actions i { color: #aaa; cursor: pointer; font-size: 1rem; }
        .diary-pager { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: -10px; margin-bottom: 15px; color: white; font-size: 0.85rem; }
        .diary-pager i { cursor: pointer; font-size: 1.2rem; transition: 0.2s; }

        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; cursor: zoom-out; }
        .lightbox img { max-width: 90%; max-height: 85%; border-radius: 10px; border: 4px solid white; }

        .member-checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; background: #fdfdfd; padding: 12px; border-radius: 12px; border: 1px solid #eee; max-height: 160px; overflow-y: auto; }
        .member-tag { font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; border: 1px solid var(--serenity); color: var(--serenity); cursor: pointer; }
        .member-tag.active { background: var(--serenity); color: white; }

        .bottom-nav { 
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; 
            background: white; display: flex; justify-content: space-around; align-items: center; 
            padding: 8px 0; border-top: 1px solid #eee; z-index: 1000; height: 75px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item { color: #ccc; text-align: center; flex: 1; cursor: pointer; font-size: 0.75rem; position: relative; }
        .nav-item.active { color: var(--serenity); }
        .nav-center { margin-top: -35px !important; }
        .nav-center-circle { width: 60px; height: 60px; border-radius: 50%; background: var(--serenity); color: white; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin: 0 auto; }
        .btn-svt { background: var(--serenity); color: white; border-radius: 50px; border: 2px solid var(--serenity); padding: 8px 20px; font-weight: bold; width: 100%; transition: all 0.3s; }
        
        .img-preview-container { position: relative; display: inline-block; }
        .img-preview-sm { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; display: block; }
        .img-remove-btn { position: absolute; top: -5px; right: -5px; background: white; color: #ff5e5e; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; border: none; }
    </style>
</head>
<body>

<div id="lightbox" class="lightbox" onclick="this.style.display='none'">
    <img src="" id="lightbox-img">
</div>

<div class="app-container" id="mainContainer">
    <input type="file" id="universal-uploader" style="display:none;" accept="image/*">

    <div id="cropperModal">
        <div class="cropper-container-box"><img id="image-to-crop"></div>
        <div class="crop-controls">
            <button class="btn-fab btn-fab-cancel" onclick="closeCropper()"><i class="fas fa-times"></i></button>
            <button class="btn-fab btn-fab-ok" onclick="confirmCrop()"><i class="fas fa-check"></i></button>
        </div>
    </div>

    <div id="memberModal" class="member-detail-modal">
        <span class="float-end fs-2" onclick="closeMemberModal()" style="cursor:pointer;">&times;</span>
        <div class="d-flex align-items-center mt-4 mb-2">
            <div id="modal-member-avatar" class="modal-avatar"></div>
            <h3 id="modal-member-name" class="fw-bold m-0" style="color:var(--serenity)"></h3>
        </div>
        <hr>
        <div id="modal-content"></div>
    </div>

    <section id="page-profile" class="page-section active" style="padding:0;">
        <div id="prof-bg" class="profile-header" onclick="startPhotoProcess('bg')">
            <div class="profile-avatar-container" onclick="event.stopPropagation(); startPhotoProcess('avatar')">
                <div id="prof-avatar-content"><i class="fas fa-gem" style="color:var(--serenity); font-size:2rem;"></i></div>
            </div>
        </div>
        <div class="p-4 bg-white shadow-sm mb-3" style="padding-top: 50px !important;">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="d-flex align-items-center mb-1">
                        <h4 id="display-name" class="fw-bold m-0" style="color:var(--serenity)">Carat</h4>
                        <i class="fas fa-pen ms-2 text-muted" style="cursor:pointer; font-size: 0.9rem; opacity: 0.7;" onclick="toggleEdit()"></i>
                    </div>
                    <p id="display-status" class="text-muted small mb-0">say the name!</p>
                </div>
            </div>
            <div id="edit-fields" style="display:none;" class="mt-3 p-3 bg-light rounded">
                <input type="text" id="input-name" class="form-control form-control-sm mb-2" placeholder="Êö±Á®±">
                <input type="text" id="input-status" class="form-control form-control-sm mb-2" placeholder="ÁãÄÊÖãÊ∂àÊÅØ">
                <button class="btn btn-sm btn-svt w-100" onclick="saveProfileText()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
        <div class="px-3">
            <div class="section-header">ÂàóË°®</div>
            <div id="member-ratings"></div>
        </div>
    </section>

    <section id="page-finance" class="page-section">
        <div class="section-header">Ë®òÂ∏≥</div>
        <div class="svt-card">
            <label class="small text-muted mb-1">Êó•Êúü</label>
            <input type="date" id="fin-date" class="form-control mb-3" onchange="syncSelectedDate(this.value)">
            <label class="small text-muted mb-1">ÊàêÂì°</label>
            <div id="fin-member-multi" class="member-checkbox-group mb-3"></div>
            <label class="small text-muted mb-1">È°ûÂà•</label>
            <select id="fin-category" class="form-select mb-3">
                <option>Â∞àËºØ</option><option>Â∞èÂç°</option><option>Âë®ÈÇä</option><option>ÂÖ∂‰ªñ</option>
            </select>
            <label class="small text-muted mb-1">ÈáëÈ°ç</label>
            <div class="input-group mb-3">
                <select id="fin-currency" class="form-select" style="max-width:90px;"><option value="TWD">Âè∞Âπ£</option><option value="KRW">ÈüìÂÖÉ</option><option value="JPY">Êó•Âúì</option></select>
                <input type="number" id="fin-amt" class="form-control" placeholder="ÈáëÈ°ç">
            </div>
            <button id="btn-save-finance" class="btn btn-svt" onclick="addFinance()">ÂÑ≤Â≠ò</button>
            <button id="btn-cancel-edit-finance" class="btn btn-sm btn-light mt-2 w-100" style="display:none;" onclick="resetFinanceForm()">ÂèñÊ∂àÁ∑®ËºØ</button>
        </div>
        <div id="list-finance"></div>
    </section>

    <section id="page-diary" class="page-section">
        <div class="section-header">Êó•Ë®ò</div>
        <div class="calendar-nav">
            <div class="cal-header">
                <i class="fas fa-chevron-left" style="color:var(--serenity); cursor:pointer" onclick="changeWeek(-1)"></i>
                <div class="cal-month" id="cal-month-display"></div>
                <i class="fas fa-chevron-right" style="color:var(--serenity); cursor:pointer" onclick="changeWeek(1)"></i>
            </div>
            <div class="week-table" id="week-table-display"></div>
        </div>
        <button id="add-diary-btn" class="btn btn-svt mb-3" onclick="toggleDiaryForm()"><i class="fas fa-plus"></i> Êñ∞Â¢ûÊó•Ë®ò</button>
        <div id="diary-form-container" class="svt-card" style="display:none;">
            <label class="small text-muted mb-1">ÈÅ∏ÊìáÊó•Êúü</label>
            <input type="date" id="diary-date" class="form-control mb-3" onchange="syncSelectedDate(this.value)">
            <label class="small text-muted mb-1">ÊàêÂì°</label>
            <div id="diary-member-multi" class="member-checkbox-group mb-3"></div>
            <textarea id="diary-content" class="form-control mb-3" rows="3" placeholder="‰ªäÂ§©Ë¶ÅÁ¥ÄÈåÑÔΩû"></textarea>
            <div class="d-flex align-items-center gap-3 mb-3">
                <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('diary-img-input').click()"><i class="fas fa-camera"></i> ‰∏äÂÇ≥ÂúñÁâá</button>
                <div id="diary-img-preview-container"></div>
            </div>
            <input type="file" id="diary-img-input" style="display:none" accept="image/*" onchange="handleDiaryImage(this)">
            <button id="btn-save-diary" class="btn btn-svt" onclick="saveDiary()">ÂÑ≤Â≠ò</button>
        </div>
        <div id="diary-display-area">
            <div id="diary-pagination" class="diary-pager"></div>
            <div id="daily-merged-content"></div>
        </div>
    </section>
</div>

<nav class="bottom-nav">
    <div class="nav-item" onclick="showPage('finance')"><i class="fas fa-wallet"></i><br>Ë®òÂ∏≥</div>
    <div class="nav-item active nav-center" onclick="showPage('profile')">
        <div class="nav-center-circle"><i class="fas fa-gem" style="font-size:1.5rem;"></i></div>
        <span>‰∏ªÈ†Å</span>
    </div>
    <div class="nav-item" onclick="showPage('diary')"><i class="fas fa-book"></i><br>Êó•Ë®ò</div>
</nav>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    const members = ["S.COUPS", "JEONGHAN", "JOSHUA", "JUN", "HOSHI", "WONWOO", "WOOZI", "THE 8", "MINGYU", "DK", "SEUNGKWAN", "VERNON", "DINO"];
    const KEY_PREFIX = 'SVT_V28_SYNC';
    const db = {
        get: (key, def) => JSON.parse(localStorage.getItem(`${KEY_PREFIX}_${key}`)) || def,
        set: (key, val) => localStorage.setItem(`${KEY_PREFIX}_${key}`, JSON.stringify(val))
    };

    let selectedDate = new Date().toLocaleDateString('en-CA');
    let currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
    
    let cropper = null, currentProcessType = '', diaryTempImg = "", editFinId = null, currentDiaryIndex = 0, editingDiaryIdx = null;

    function init() {
        const tags = members.map(m => `<span class="member-tag" onclick="this.classList.toggle('active')">${m}</span>`).join('');
        document.getElementById('fin-member-multi').innerHTML = tags;
        document.getElementById('diary-member-multi').innerHTML = tags;
        document.getElementById('fin-date').value = selectedDate;
        document.getElementById('diary-date').value = selectedDate;
        renderWeekTable(); renderDiaryContent(); renderProfile(); renderFinance();
    }

    function syncSelectedDate(date) { 
        if(!date) return;
        selectedDate = date; currentDiaryIndex = 0; 
        document.getElementById('diary-date').value = date; 
        document.getElementById('fin-date').value = date; 
        let d = new Date(date);
        currentWeekStart = new Date(d);
        currentWeekStart.setDate(d.getDate() - d.getDay());
        renderWeekTable(); renderDiaryContent(); 
    }

    function openMemberModal(name) {
        const finList = db.get('fin_list', []).filter(i => i.members.includes(name));
        const diaryData = db.get('diary_list', {});
        const pics = db.get('member_pics', {});
        let diaries = [];
        Object.keys(diaryData).forEach(date => {
            let list = Array.isArray(diaryData[date]) ? diaryData[date] : [diaryData[date]];
            list.forEach(entry => { if (entry.members?.includes(name)) diaries.push({ date, content: entry.content }); });
        });
        document.getElementById('modal-member-name').innerText = name;
        document.getElementById('modal-member-avatar').innerHTML = pics[name] ? `<img src="${pics[name]}">` : `<i class="fas fa-gem" style="color:var(--serenity); font-size:1.5rem;"></i>`;
        let html = `<p class="small text-muted">ÈóúÊñº ${name} ÁöÑÊâÄÊúâÁ¥ÄÈåÑÔºö</p>`;
        html += `<div class="fw-bold mt-3 mb-2 text-serenity">Ë®òÂ∏≥Á¥ÄÈåÑ üí≥</div>`;
        html += finList.length ? finList.map(f => `<div class="sync-fin-item d-flex justify-content-between"><span>${f.date}</span><span class="fw-bold">${f.currency} ${f.amt}</span></div>`).join('') : '<p class="small text-muted">Êö´ÁÑ°Ë®òÂ∏≥Á¥ÄÈåÑ</p>';
        html += `<div class="fw-bold mt-4 mb-2 text-serenity">Êó•Ë®òÁ¥ÄÈåÑüìî</div>`;
        html += diaries.length ? diaries.map(d => `<div class="p-2 bg-light rounded mb-2 small"><b class="text-serenity">${d.date}</b><br>${d.content}</div>`).join('') : '<p class="small text-muted">Êö´Êú™Âú®Êó•Ë®ò‰∏≠Ë¢´ÊèêÂèä</p>';
        document.getElementById('modal-content').innerHTML = html;
        
        // ÂÅΩÈ†ÅÈù¢È°ØÁ§∫ÈÇèËºØ
        const modal = document.getElementById('memberModal');
        modal.style.display = 'block';
        document.getElementById('mainContainer').scrollTo(0, 0); // ËÆìÂ§ñÈÉ®ÂÆπÂô®ÊªæÂõûÈ†ÇÈÉ®È°ØÁ§∫ÂÅΩÈ†ÅÈù¢
    }
    function closeMemberModal() { document.getElementById('memberModal').style.display = 'none'; }

    function startPhotoProcess(type) { currentProcessType = type; document.getElementById('universal-uploader').click(); }
    document.getElementById('universal-uploader').onchange = function(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = document.getElementById('image-to-crop'); img.src = event.target.result;
            document.getElementById('cropperModal').style.display = 'flex';
            if (cropper) cropper.destroy();
            cropper = new Cropper(img, { aspectRatio: (currentProcessType==='bg'?500/160:1), viewMode: 1 });
        };
        reader.readAsDataURL(file);
    };
    function confirmCrop() {
        const canvas = cropper.getCroppedCanvas({ width: currentProcessType === 'bg' ? 1000 : 400 });
        const croppedImg = canvas.toDataURL('image/jpeg', 0.8);
        if (['bg','avatar'].includes(currentProcessType)) {
            const prof = db.get('profile', {}); prof[currentProcessType] = croppedImg; db.set('profile', prof);
        } else {
            const pics = db.get('member_pics', {}); pics[currentProcessType] = croppedImg; db.set('member_pics', pics);
        }
        renderProfile(); closeCropper();
    }
    function closeCropper() { document.getElementById('cropperModal').style.display = 'none'; if (cropper) cropper.destroy(); }

    function addFinance() {
        const date = document.getElementById('fin-date').value, amt = document.getElementById('fin-amt').value;
        const tags = Array.from(document.querySelectorAll('#fin-member-multi .member-tag.active')).map(el => el.innerText);
        if(!amt || !tags.length) return alert('Ë≥áË®ä‰∏çÂÆåÊï¥');
        let list = db.get('fin_list', []);
        if (editFinId) {
            const idx = list.findIndex(i => i.id === editFinId);
            if (idx !== -1) list[idx] = { ...list[idx], date, members: tags, amt, currency: document.getElementById('fin-currency').value, category: document.getElementById('fin-category').value };
            editFinId = null;
        } else list.unshift({ id: Date.now(), date, members: tags, amt, currency: document.getElementById('fin-currency').value, category: document.getElementById('fin-category').value });
        db.set('fin_list', list); resetFinanceForm(); renderFinance();
    }
    function deleteFinance(id) { if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ôºü')) { db.set('fin_list', db.get('fin_list', []).filter(i => i.id !== id)); renderFinance(); } }
    function editFinance(id) {
        const item = db.get('fin_list', []).find(i => i.id === id); if(!item) return;
        syncSelectedDate(item.date); document.getElementById('fin-amt').value = item.amt;
        document.querySelectorAll('#fin-member-multi .member-tag').forEach(tag => tag.classList.toggle('active', item.members.includes(tag.innerText)));
        editFinId = id; document.getElementById('btn-save-finance').innerText = "Êõ¥Êñ∞Á¥ÄÈåÑ"; document.getElementById('btn-cancel-edit-finance').style.display = "block"; 
        document.getElementById('mainContainer').scrollTo(0,0);
    }
    function resetFinanceForm() { editFinId = null; document.getElementById('fin-amt').value = ""; document.getElementById('btn-save-finance').innerText = "ÂÑ≤Â≠ò"; document.getElementById('btn-cancel-edit-finance').style.display = "none"; document.querySelectorAll('#fin-member-multi .member-tag').forEach(tag => tag.classList.remove('active')); }
    function renderFinance() {
        document.getElementById('list-finance').innerHTML = db.get('fin_list', []).map(i => `<div class="svt-card d-flex justify-content-between align-items-center"><div><div class="small text-muted">${i.date} ¬∑ ${i.category}</div><div class="fw-bold text-serenity">${i.members.join(', ')}</div><div class="fw-bold">${i.currency} ${i.amt}</div></div><div class="d-flex gap-3"><i class="fas fa-pen" onclick="editFinance(${i.id})"></i><i class="fas fa-times" onclick="deleteFinance(${i.id})"></i></div></div>`).join('');
    }

    function toggleDiaryForm() {
        const c = document.getElementById('diary-form-container'), isHidden = c.style.display === 'none';
        c.style.display = isHidden ? 'block' : 'none';
        document.getElementById('add-diary-btn').innerHTML = isHidden ? '<i class="fas fa-times"></i> ÂèñÊ∂à' : '<i class="fas fa-plus"></i> Êñ∞Â¢ûÊó•Ë®ò';
        if(!isHidden) resetDiaryForm();
    }
    function handleDiaryImage(input) { if (input.files?.[0]) { const r = new FileReader(); r.onload = e => { diaryTempImg = e.target.result; document.getElementById('diary-img-preview-container').innerHTML = `<div class="img-preview-container"><img src="${diaryTempImg}" class="img-preview-sm"><button class="img-remove-btn" onclick="removeDiaryImage()">&times;</button></div>`; }; r.readAsDataURL(input.files[0]); } }
    function removeDiaryImage() { diaryTempImg = ""; document.getElementById('diary-img-preview-container').innerHTML = ""; }
    function saveDiary() {
        const content = document.getElementById('diary-content').value, date = document.getElementById('diary-date').value;
        if(!content) return alert("Ë´ãËº∏ÂÖ•ÂÖßÂÆπ");
        let diaries = db.get('diary_list', {}); if (!Array.isArray(diaries[date])) diaries[date] = diaries[date] ? [diaries[date]] : [];
        const entry = { content, members: Array.from(document.querySelectorAll('#diary-member-multi .member-tag.active')).map(el => el.innerText), img: diaryTempImg };
        if (editingDiaryIdx !== null) diaries[date][editingDiaryIdx] = entry; else { diaries[date].push(entry); currentDiaryIndex = diaries[date].length - 1; }
        db.set('diary_list', diaries); toggleDiaryForm(); renderDiaryContent();
    }
    function renderDiaryContent() {
        const list = db.get('diary_list', {})[selectedDate] || [];
        const display = document.getElementById('daily-merged-content'), pager = document.getElementById('diary-pagination');
        if (list.length > 0) {
            const data = list[currentDiaryIndex] || list[0];
            pager.innerHTML = list.length > 1 ? `<i class="fas fa-chevron-left" onclick="changeDiaryPage(-1)"></i> <span>${currentDiaryIndex+1}/${list.length}</span> <i class="fas fa-chevron-right" onclick="changeDiaryPage(1)"></i>` : "";
            display.innerHTML = `<div class="diary-paper"><div class="diary-actions"><i class="fas fa-pen" onclick="editDiary()"></i><i class="fas fa-times" onclick="deleteDiary()"></i></div><div class="diary-content-text">${data.content}</div>${data.img ? `<img src="${data.img}" class="diary-thumb" onclick="openLightbox(this.src)">` : ''}</div>`;
        } else { pager.innerHTML = ""; display.innerHTML = `<div class="text-center p-5 text-white">ÈÄôÂ§©Ê≤íÊúâÁ¥ÄÈåÑüíé</div>`; }
    }
    function editDiary() {
        const data = db.get('diary_list', {})[selectedDate][currentDiaryIndex]; editingDiaryIdx = currentDiaryIndex;
        toggleDiaryForm(); document.getElementById('diary-content').value = data.content;
        if(data.img) { diaryTempImg = data.img; document.getElementById('diary-img-preview-container').innerHTML = `<div class="img-preview-container"><img src="${diaryTempImg}" class="img-preview-sm"><button class="img-remove-btn" onclick="removeDiaryImage()">&times;</button></div>`; }
        document.querySelectorAll('#diary-member-multi .member-tag').forEach(tag => tag.classList.toggle('active', data.members?.includes(tag.innerText)));
    }
    function deleteDiary() { if(confirm('Âà™Èô§Ôºü')) { let d = db.get('diary_list', {}); d[selectedDate].splice(currentDiaryIndex, 1); db.set('diary_list', d); currentDiaryIndex = 0; renderDiaryContent(); } }
    function changeDiaryPage(dir) { const len = (db.get('diary_list', {})[selectedDate] || []).length; currentDiaryIndex = (currentDiaryIndex + dir + len) % len; renderDiaryContent(); }
    function resetDiaryForm() { editingDiaryIdx = null; diaryTempImg = ""; document.getElementById('diary-content').value = ""; document.getElementById('diary-img-preview-container').innerHTML = ""; document.querySelectorAll('#diary-member-multi .member-tag').forEach(tag => tag.classList.remove('active')); }

    function renderProfile() {
        const prof = db.get('profile', { name: "Carat", status: "Say the name!", avatar: "", bg: "" }), ratings = db.get('ratings', {}), pics = db.get('member_pics', {});
        document.getElementById('display-name').innerText = prof.name; document.getElementById('display-status').innerText = prof.status;
        if(prof.avatar) document.getElementById('prof-avatar-content').innerHTML = `<img src="${prof.avatar}">`;
        if(prof.bg) document.getElementById('prof-bg').style.backgroundImage = `url(${prof.bg})`;
        document.getElementById('member-ratings').innerHTML = members.map(m => `<div class="svt-card d-flex align-items-center justify-content-between py-2"><div class="d-flex align-items-center"><div class="member-avatar-sm" onclick="startPhotoProcess('${m}')">${pics[m] ? `<img src="${pics[m]}">` : `<i class="fas fa-gem" style="color:white; font-size:0.8rem;"></i>`}</div><span class="fw-bold text-serenity" style="cursor:pointer;" onclick="openMemberModal('${m}')">${m}</span></div><div class="d-flex align-items-center">${[1,2,3,4,5].map(n => `<i class="fas fa-gem gem-rating ${(ratings[m]||0) >= n ? 'active' : ''}" onclick="updateRate('${m}', ${n})"></i>`).join('')}<i class="fas fa-sync-alt reset-btn" onclick="updateRate('${m}', 0)"></i></div></div>`).join('');
    }
    function updateRate(m, s) { const r = db.get('ratings', {}); r[m] = s; db.set('ratings', r); renderProfile(); }
    function toggleEdit() { const f = document.getElementById('edit-fields'); f.style.display = (f.style.display === 'none') ? 'block' : 'none'; }
    function saveProfileText() { const prof = db.get('profile', {}); prof.name = document.getElementById('input-name').value || "Carat"; prof.status = document.getElementById('input-status').value || "Say the name!"; db.set('profile', prof); renderProfile(); toggleEdit(); }
    function renderWeekTable() {
        const table = document.getElementById('week-table-display'); table.innerHTML = ""; const days = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'], temp = new Date(currentWeekStart);
        for (let i = 0; i < 7; i++) {
            const dStr = temp.toLocaleDateString('en-CA');
            table.innerHTML += `<div class="day-item ${dStr === selectedDate ? 'active' : ''}" onclick="syncSelectedDate('${dStr}')"><span>${days[i]}</span>${temp.getDate()}</div>`;
            temp.setDate(temp.getDate() + 1);
        }
        document.getElementById('cal-month-display').innerText = `${currentWeekStart.getFullYear()}/${currentWeekStart.getMonth()+1}`;
    }
    function changeWeek(dir) { currentWeekStart.setDate(currentWeekStart.getDate() + (dir*7)); renderWeekTable(); }
    function showPage(id) {
        closeMemberModal();
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach((n, idx) => n.classList.toggle('active', ['finance', 'profile', 'diary'][idx] === id));
        document.getElementById('mainContainer').scrollTo(0, 0);
    }
    function openLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').style.display = 'flex'; }
    window.onload = init;
</script>
</body>
</html>
