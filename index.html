<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVT è¿½æ˜Ÿç”Ÿæ´»æ‰‹å¸³ ğŸ’</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Noto+Sans+TC:wght@500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <style>
        :root { --rose-quartz: #F7CAC9; --serenity: #92A8D1; }
        body {
            background: linear-gradient(180deg, var(--rose-quartz) 0%, var(--serenity) 100%);
            background-attachment: fixed; min-height: 100vh;
            font-family: 'Kiwi Maru', 'Noto Sans TC', sans-serif;
            color: #555; padding-bottom: 120px;
        }
        .app-container { max-width: 500px; margin: 0 auto; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); min-height: 100vh; position: relative; }
        
        /* å…¬ç”¨çµ„ä»¶ */
        .section-header { background-color: var(--serenity); color: white; padding: 6px 18px; border-radius: 50px; display: inline-block; font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(146, 168, 209, 0.3); }
        .hint-text { font-size: 0.7rem; color: #777; line-height: 1.5; margin-bottom: 15px; padding-left: 5px; }
        .svt-card { background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(146, 168, 209, 0.2); }
        .btn-svt { background: var(--serenity); color: white; border-radius: 50px; border: none; padding: 6px 16px; font-weight: bold; }
        .text-serenity { color: var(--serenity) !important; }

        /* ä¸»é ç‰¹å®šæ¨£å¼ */
        .profile-header { height: 160px; background: #eee center/cover; position: relative; border-bottom: 4px solid white; cursor: pointer; }
        .profile-avatar { width: 90px; height: 90px; border-radius: 50%; border: 4px solid white; position: absolute; bottom: -45px; left: 20px; background: white; object-fit: cover; cursor: pointer; z-index: 10; }
        
        /* æ›´æ–°æˆå“¡é è¨­é ­åƒèƒŒæ™¯åŠé‘½çŸ³é¡è‰² */
        .member-avatar-sm { 
            width: 38px; height: 38px; border-radius: 50%; margin-right: 12px; border: 1.5px solid white; cursor: pointer; 
            background: linear-gradient(135deg, var(--rose-quartz), var(--serenity)); /* èˆ‡å°è¦½åˆ—ä¸»é æŒ‰éˆ•èƒŒæ™¯ä¸€è‡´ */
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; 
        }
        .member-avatar-sm img { width: 100%; height: 100%; object-fit: cover; }
        .hand-drawn-diamond { 
            width: 22px; height: 22px; stroke: white; fill: none; /* é‘½çŸ³ç·šæ¢æ”¹ç‚ºç™½è‰² */
            stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; 
        }
        .gem-rating { font-size: 0.8rem; color: #eee; cursor: pointer; }
        .gem-rating.active { color: var(--serenity); }
        .reset-btn { font-size: 0.7rem; color: #ddd; cursor: pointer; margin-left: 8px; transition: 0.3s; }
        .reset-btn:hover { color: var(--rose-quartz); transform: rotate(90deg); }

        /* å°è¦½åˆ— */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background: white; display: flex; justify-content: space-around; align-items: center; padding: 8px 0; border-top: 1px solid #eee; z-index: 1000; height: 75px; }
        .nav-item { color: #ccc; text-align: center; flex: 1; cursor: pointer; font-size: 0.75rem; }
        .nav-item i { font-size: 1.2rem; display: block; }
        .nav-item.active { color: var(--serenity); }
        .nav-avatar-btn { width: 55px; height: 55px; border-radius: 50%; border: 3px solid white; object-fit: cover; background: var(--serenity); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* å…§å®¹å€å¡Š */
        .page-section { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å½ˆçª— */
        .member-detail-modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; height: 100%; background: #fdfdfd; z-index: 2000; display: none; overflow-y: auto; padding: 25px; }
        .mini-pc { width: 80px; height: 120px; object-fit: cover; border-radius: 8px; margin: 4px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div class="app-container">
    <input type="file" id="member-file-input" style="display:none;" accept="image/*">
    <input type="file" id="bg-trigger" style="display:none;" accept="image/*" onchange="handleImageUpload('bg')">
    <input type="file" id="av-trigger" style="display:none;" accept="image/*" onchange="handleImageUpload('avatar')">

    <section id="page-finance" class="page-section">
        <div class="section-header">æ”¯å‡ºç®¡ç†</div>
        <div class="svt-card">
            <input type="date" id="fin-date" class="form-control mb-2">
            <select id="fin-member-select" class="form-select mb-2"></select>
            <input type="text" id="fin-name" class="form-control mb-2" placeholder="æ”¯å‡ºé …ç›® (ä¾‹å¦‚ï¼šå°ˆè¼¯)">
            <input type="number" id="fin-amt" class="form-control mb-2" placeholder="é‡‘é¡">
            <button class="btn btn-svt w-100" onclick="addFinance()">å„²å­˜ç´€éŒ„</button>
        </div>
        <div id="list-finance"></div>
    </section>

    <section id="page-diary" class="page-section">
        <div class="section-header">è¿½æ˜Ÿæ—¥è¨˜</div>
        <div id="calendar" class="bg-white p-2 rounded mb-3"></div>
        <div class="svt-card">
            <input type="date" id="diary-date" class="form-control mb-2">
            <textarea id="diary-content" class="form-control mb-2" rows="3" placeholder="å¯«ä¸‹å¿ƒæƒ…... (æåˆ°æˆå“¡åå­—å¯è‡ªå‹•é€£çµ)"></textarea>
            <button class="btn btn-svt w-100" onclick="addDiary()">å„²å­˜æ—¥è¨˜</button>
        </div>
        <div id="selected-day-diary"></div>
    </section>

    <section id="page-profile" class="page-section active" style="padding:0;">
        <div id="prof-bg" class="profile-header" onclick="document.getElementById('bg-trigger').click()">
            <img id="prof-avatar-img" src="" class="profile-avatar" onclick="event.stopPropagation(); document.getElementById('av-trigger').click()">
        </div>
        
        <div style="padding: 55px 20px 15px 20px; background: white; margin-bottom: 10px;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 id="display-name" class="fw-bold m-0 text-serenity">Carat</h4>
                    <p id="display-status" class="text-muted small mb-0">Say the name, SEVENTEEN!</p>
                </div>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="toggleEdit()">ç·¨è¼¯è³‡æ–™</button>
            </div>
            <div id="edit-fields" style="display:none;" class="mt-3 p-3 bg-light rounded shadow-sm">
                <input type="text" id="input-name" class="form-control form-control-sm mb-2" placeholder="æ›´æ–°æš±ç¨±">
                <input type="text" id="input-status" class="form-control form-control-sm mb-2" placeholder="æ›´æ–°ç‹€æ…‹æ¶ˆæ¯">
                <button class="btn btn-svt btn-sm w-100" onclick="saveProfileText()">å„²å­˜æ–‡å­—è³‡æ–™</button>
            </div>
        </div>

        <div class="px-3">
            <div class="section-header">æˆå“¡åˆ—è¡¨</div>
            <div class="hint-text">
                â— é»æ“Šé ­è²¼ã€èƒŒæ™¯å¯æ›´æ›åœ–ç‰‡<br>
                â— é»æ“Šæˆå“¡å¯çœ‹ç›¸é—œå…§å®¹<br>
                â— è‹¥åœ–ç‰‡æ›´æ–°å¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨è¼ƒå°çš„æª”æ¡ˆ
            </div>
            <div id="member-ratings"></div>
            <div style="height:80px;"></div>
        </div>
    </section>

    <section id="page-translate" class="page-section">
        <div class="section-header">Google ç¿»è­¯</div>
        <div class="svt-card text-center">
            <p class="small">åˆ‡æ›éŸ“æ–‡/ä¸­æ–‡ç¿»è­¯</p>
            <a href="https://translate.google.com/?sl=ko&tl=zh-TW" target="_blank" class="btn btn-svt w-100 mb-3">æ‰“é–‹ç¿»è­¯å®˜ç¶²</a>
            <iframe src="https://translate.google.com/m?sl=ko&tl=zh-TW" style="width:100%; height:400px; border-radius:10px; border:none;"></iframe>
        </div>
    </section>

    <section id="page-album" class="page-section">
        <div class="section-header">å¡å†Šæ”¶è—</div>
        <div class="svt-card">
            <select id="pc-member-select" class="form-select mb-2"></select>
            <input type="file" id="pc-file" class="form-control mb-2" accept="image/*">
            <button class="btn btn-svt w-100" onclick="addPC()">åŠ å…¥æ”¶è—</button>
        </div>
        <div id="list-pc" class="row g-2"></div>
    </section>

    <div id="memberModal" class="member-detail-modal">
        <span class="float-end fs-2" onclick="closeMemberModal()" style="cursor:pointer;">&times;</span>
        <h3 id="modal-member-name" class="fw-bold text-serenity mt-4"></h3>
        <hr>
        <div id="modal-content"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="showPage('finance', this)"><i class="fas fa-wallet"></i><span>è¨˜å¸³</span></div>
        <div class="nav-item" onclick="showPage('diary', this)"><i class="fas fa-book"></i><span>æ—¥è¨˜</span></div>
        <div class="nav-item active" onclick="showPage('profile', this)" style="margin-top:-25px;">
            <div id="nav-avatar-container" class="nav-avatar-btn">ä¸»é </div>
        </div>
        <div class="nav-item" onclick="showPage('translate', this)"><i class="fas fa-language"></i><span>ç¿»è­¯</span></div>
        <div class="nav-item" onclick="showPage('album', this)"><i class="fas fa-images"></i><span>å¡å†Š</span></div>
    </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    const members = ["S.COUPS", "JEONGHAN", "JOSHUA", "JUN", "HOSHI", "WONWOO", "WOOZI", "THE 8", "MINGYU", "DK", "SEUNGKWAN", "VERNON", "DINO"];
    const KEY = 'svt_final_v68_'; // æ›´æ–° KEY ä»¥é¿å…èˆ‡èˆŠç‰ˆè³‡æ–™æ··æ·†
    
    // åŸºç¤è³‡æ–™è™•ç† (å«è¨ºæ–·)
    const getL = k => { try { return JSON.parse(localStorage.getItem(KEY+k)) || (k.includes('list')?[]:{}); } catch(e) { return k.includes('list')?[]:{}; } };
    const setL = (k, v) => {
        try {
            localStorage.setItem(KEY+k, JSON.stringify(v));
            return true;
        } catch(e) {
            alert("âš ï¸ å„²å­˜å¤±æ•—ï¼šç©ºé–“å·²æ»¿ï¼\nå»ºè­°åˆªé™¤ä¸€äº›èˆŠçš„ç…§ç‰‡æˆ–ç´€éŒ„å†è©¦ã€‚");
            return false;
        }
    };

    // --- ä¸»é æ¸²æŸ“èˆ‡åœ–ç‰‡è™•ç† ---
    function renderProfile() {
        const info = getL('profile'), pics = getL('member_pics'), ratings = getL('ratings');
        document.getElementById('display-name').innerText = info.name || "Carat";
        document.getElementById('display-status').innerText = info.status || "Say the name, SEVENTEEN!";
        
        const avImg = document.getElementById('prof-avatar-img'), navC = document.getElementById('nav-avatar-container');
        if(info.avatar) {
            avImg.src = info.avatar;
            navC.innerHTML = `<img src="${info.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        } else {
            avImg.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='90' height='90'%3E%3Crect width='90' height='90' fill='%23eee'/%3E%3C/svg%3E"; // é è¨­é ­åƒä½”ä½ç¬¦
            navC.innerHTML = "ä¸»é ";
        }
        if(info.bg) document.getElementById('prof-bg').style.backgroundImage = `url(${info.bg})`;

        document.getElementById('member-ratings').innerHTML = members.map(m => {
            const hasPic = pics[m];
            const currentRating = ratings[m] || 0;
            return `<div class="svt-card d-flex align-items-center justify-content-between py-2">
                <div class="d-flex align-items-center">
                    <div class="member-avatar-sm" onclick="triggerMemberPic('${m}')">
                        ${hasPic ? `<img src="${hasPic}">` : `<svg class="hand-drawn-diamond" viewBox="0 0 24 24"><path d="M12 3 L18 8 L12 21 L6 8 Z M6 8 L18 8 M9 3 L9 8 M15 3 L15 8 M9 8 L12 21 L15 8" /></svg>`}
                    </div>
                    <span class="fw-bold text-serenity small" onclick="openMemberModal('${m}')" style="cursor:pointer;">${m}</span>
                </div>
                <div class="d-flex align-items-center">
                    ${[1,2,3,4,5].map(n => `<i class="fas fa-gem gem-rating ${currentRating >= n ? 'active' : ''} mx-1" onclick="rate('${m}', ${n})"></i>`).join('')}
                    <i class="fas fa-sync-alt reset-btn" onclick="rate('${m}', 0)"></i>
                </div>
            </div>`;
        }).join('');
    }

    async function handleImageUpload(type) {
        const file = document.getElementById(type === 'bg' ? 'bg-trigger' : 'av-trigger').files[0];
        if (!file) return;
        const compressed = await compressImage(file, type === 'bg' ? 800 : 300, 0.5);
        if(!compressed) return;
        const info = getL('profile');
        info[type] = compressed;
        if(setL('profile', info)) renderProfile();
    }

    let targetMember = "";
    function triggerMemberPic(m) { targetMember = m; document.getElementById('member-file-input').click(); }
    document.getElementById('member-file-input').onchange = async function(e) {
        if(!e.target.files[0]) return;
        const compressed = await compressImage(e.target.files[0], 200, 0.5);
        if(!compressed) return;
        const pics = getL('member_pics');
        pics[targetMember] = compressed;
        if(setL('member_pics', pics)) renderProfile();
    };

    // --- å„é é¢åŠŸèƒ½å¯¦ä½œ ---
    function addFinance() {
        const m = document.getElementById('fin-member-select').value, n = document.getElementById('fin-name').value, a = document.getElementById('fin-amt').value, d = document.getElementById('fin-date').value;
        if(!n || !a || !d) { alert('è«‹å¡«å¯«å®Œæ•´è¨˜å¸³è³‡è¨Šï¼'); return; }
        const list = getL('fin_list');
        list.unshift({ id: Date.now(), member: m, name: n, amt: a, date: d });
        setL('fin_list', list); renderFinance();
        // æ¸…ç©ºè¡¨å–®
        document.getElementById('fin-name').value = '';
        document.getElementById('fin-amt').value = '';
    }
    function renderFinance() {
        document.getElementById('list-finance').innerHTML = getL('fin_list').map(i => `<div class="svt-card d-flex justify-content-between"><div><b>[${i.member}]</b> ${i.name}</div><div class="text-serenity fw-bold">$${i.amt}</div></div>`).join('');
    }

    async function addPC() {
        const m = document.getElementById('pc-member-select').value, f = document.getElementById('pc-file').files[0];
        if(!f) { alert('è«‹é¸æ“‡åœ–ç‰‡ï¼'); return; }
        const img = await compressImage(f, 600, 0.5);
        if(!img) return;
        const list = getL('pc_list');
        list.unshift({ id: Date.now(), mem: m, img });
        if(setL('pc_list', list)) renderPC();
        document.getElementById('pc-file').value = ''; // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
    }
    function renderPC() {
        document.getElementById('list-pc').innerHTML = getL('pc_list').map(i => `<div class="col-4"><img src="${i.img}" class="img-fluid rounded"></div>`).join('');
    }

    function addDiary() {
        const c = document.getElementById('diary-content').value, d = document.getElementById('diary-date').value;
        if(!c || !d) { alert('æ—¥è¨˜å…§å®¹å’Œæ—¥æœŸä¸èƒ½ç©ºç™½å–”ï¼'); return; }
        const list = getL('diary_list');
        list.unshift({ id: Date.now(), date: d, content: c });
        if(setL('diary_list', list)) {
            alert('æ—¥è¨˜å·²å­˜å¥½å›‰ï¼');
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('diary-content').value = '';
        }
    }

    // --- å·¥å…·å‡½å¼ ---
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = (maxWidth / w) * h; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    const base64 = canvas.toDataURL('image/jpeg', quality);
                    if(base64.length > 1.5 * 1024 * 1024) { // è¶…é 1.5MB è¦–ç‚ºéå¤§
                        alert("åœ–ç‰‡é‚„æ˜¯å¤ªå¤§ï¼Œè«‹æˆªåœ–å¾Œå†ä¸Šå‚³ã€‚"); 
                        resolve(null); // è¿”å› null è¡¨ç¤ºå¤±æ•—
                    }
                    else resolve(base64);
                };
                img.onerror = () => { alert("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚"); resolve(null); };
            };
            reader.onerror = () => { alert("æª”æ¡ˆè®€å–å¤±æ•—ã€‚"); resolve(null); };
        });
    }

    function openMemberModal(name) {
        const fin = getL('fin_list').filter(i => i.member === name);
        const pcs = getL('pc_list').filter(i => i.mem === name);
        const diaries = getL('diary_list').filter(i => i.content.includes(name));
        document.getElementById('modal-member-name').innerText = name;
        let html = `<p class="small text-muted">èˆ‡ ${name} ç›¸é—œçš„æ‰€æœ‰ç´€éŒ„ï¼š</p>`;
        html += `<div class="fw-bold mt-3 text-serenity">ğŸ’° æ”¯å‡º</div>` + (fin.length ? fin.map(f => `<div class="small py-1 border-bottom d-flex justify-content-between"><span>${f.date} ${f.name}</span><span>$${f.amt}</span></div>`).join('') : '<p class="small text-muted">æš«ç„¡ç›¸é—œæ”¯å‡ºç´€éŒ„</p>');
        html += `<div class="fw-bold mt-3 text-serenity">ğŸ“· å°å¡</div><div class="d-flex flex-wrap">` + (pcs.length ? pcs.map(p => `<img src="${p.img}" class="mini-pc">`).join('') : '<p class="small text-muted">æš«ç„¡æ”¶è—å°å¡</p>') + `</div>`;
        html += `<div class="fw-bold mt-3 text-serenity">âœï¸ æ—¥è¨˜</div>` + (diaries.length ? diaries.map(d => `<div class="p-2 bg-light rounded mb-2 small"><b>${d.date}</b>: ${d.content}</div>`).join('') : '<p class="small text-muted">æš«ç„¡æ—¥è¨˜æåŠ</p>');
        document.getElementById('modal-content').innerHTML = html;
        document.getElementById('memberModal').style.display = 'block';
    }

    function showPage(p, el) {
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(p==='album') renderPC();
        if(p==='finance') renderFinance();
        // å¦‚æœæ˜¯æ—¥è¨˜é ï¼Œç¢ºä¿æ—¥æ›†æ¸²æŸ“ä¸¦é¸æ“‡ä»Šå¤©çš„æ—¥æœŸ
        if(p==='diary') {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('diary-date').value = today;
        }
    }
    
    function closeMemberModal() { document.getElementById('memberModal').style.display = 'none'; }
    function rate(m, n) { const r = getL('ratings'); r[m]=n; setL('ratings', r); renderProfile(); }
    function toggleEdit() { const d = document.getElementById('edit-fields'); d.style.display = d.style.display==='none'?'block':'none'; }
    function saveProfileText() {
        const info = getL('profile'), n = document.getElementById('input-name').value, s = document.getElementById('input-status').value;
        if(n) info.name = n; if(s) info.status = s;
        setL('profile', info); renderProfile(); toggleEdit();
    }

    window.onload = () => {
        // åˆå§‹åŒ–å„é é¢ä¸‹æ‹‰é¸å–®
        const opt = members.map(m => `<option>${m}</option>`).join('');
        document.getElementById('fin-member-select').innerHTML = opt;
        document.getElementById('pc-member-select').innerHTML = opt;
        
        // æ¸²æŸ“ä¸»é 
        renderProfile();

        // åˆå§‹åŒ–æ—¥æ›†
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 'auto',
            dateClick: function(info) {
                // é»æ“Šæ—¥æœŸå¾Œè‡ªå‹•è¨­å®šæ—¥è¨˜æ—¥æœŸ
                document.getElementById('diary-date').value = info.dateStr;
                alert('å·²é¸æ“‡æ—¥è¨˜æ—¥æœŸï¼š' + info.dateStr);
            },
            events: getL('diary_list').map(d => ({
                title: 'æ—¥è¨˜',
                start: d.date,
                color: varCSS('--rose-quartz'), // ä½¿ç”¨ä¸»é¡Œè‰²
                textColor: 'white',
            }))
        });
        calendar.render();

        // ç¢ºä¿æ—¥è¨˜é é è¨­æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('diary-date').value = new Date().toISOString().split('T')[0];
    };

    // å–å¾— CSS è®Šæ•¸å€¼ (FullCalendar ä½¿ç”¨)
    function varCSS(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name);
    }
</script>
</body>
</html>
