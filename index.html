<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVT è¿½æ˜Ÿç”Ÿæ´»ğŸ’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Noto+Sans+TC:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --rose-quartz: #F7CAC9; --serenity: #92A8D1; }
        body {
            background: linear-gradient(180deg, var(--rose-quartz) 0%, var(--serenity) 100%);
            background-attachment: fixed; min-height: 100vh;
            font-family: 'Kiwi Maru', 'Noto Sans TC', sans-serif;
            color: #555;
        }
        .app-container { max-width: 500px; margin: 0 auto; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); min-height: 100vh; position: relative; padding-bottom: 110px; }
        
        .page-section { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-header { background-color: var(--serenity); color: white; padding: 6px 18px; border-radius: 50px; display: inline-block; font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(146, 168, 209, 0.3); }
        .svt-card { background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(146, 168, 209, 0.2); position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* ä¸»é æ¨£å¼ */
        .profile-header { height: 160px; background: linear-gradient(45deg, var(--rose-quartz), var(--serenity)); position: relative; border-bottom: 4px solid white; cursor: pointer; }
        .profile-avatar-container { width: 90px; height: 90px; border-radius: 50%; border: 4px solid white; position: absolute; bottom: -45px; left: 20px; background: white; z-index: 10; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .profile-avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .member-avatar-sm { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 2px solid white; background: linear-gradient(135deg, var(--rose-quartz), var(--serenity)); overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; }
        .member-avatar-sm img { width: 100%; height: 100%; object-fit: cover; }
        .member-avatar-sm i { color: white; font-size: 0.8rem; }
        
        .gem-rating { font-size: 0.85rem; color: #eee; cursor: pointer; margin: 0 2px; }
        .gem-rating.active { color: var(--serenity); }
        .reset-btn { font-size: 0.85rem; color: #ccc; cursor: pointer; margin-left: 10px; transition: 0.3s; }
        .reset-btn:hover { color: var(--rose-quartz); transform: rotate(180deg); }

        /* å½ˆçª—æ¨£å¼å¢å¼· */
        .member-detail-modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; height: 100%; background: #fff; z-index: 2000; display: none; overflow-y: auto; padding: 25px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .modal-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--serenity); object-fit: cover; margin-right: 12px; background: linear-gradient(135deg, var(--rose-quartz), var(--serenity)); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .modal-avatar i { color: white; font-size: 1.2rem; }
        .sync-fin-item { font-size: 0.8rem; background: #f0f4f8; padding: 8px; border-left: 3px solid var(--serenity); margin-bottom: 8px; border-radius: 4px; }

        /* å°è¦½åˆ— */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background: white; display: flex; justify-content: space-around; align-items: center; padding: 8px 0; border-top: 1px solid #eee; z-index: 1000; height: 75px; }
        .nav-item { color: #ccc; text-align: center; flex: 1; cursor: pointer; font-size: 0.75rem; text-decoration: none; position: relative; }
        .nav-item.active { color: var(--serenity); }
        .nav-center { margin-top: -35px !important; }
        .nav-center-circle { width: 60px; height: 60px; border-radius: 50%; background: var(--serenity); color: white; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin: 0 auto; }
        .btn-svt { background: var(--serenity); color: white; border-radius: 50px; border: 2px solid var(--serenity); padding: 8px 20px; font-weight: bold; width: 100%; transition: all 0.3s; }
        
        .calendar-nav { background: white; border-radius: 20px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(146,168,209,0.2); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cal-month { font-weight: bold; color: var(--serenity); font-size: 1.1rem; }
        .week-table { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-item { padding: 8px 0; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .day-item span { display: block; font-size: 0.7rem; color: #aaa; margin-bottom: 2px; }
        .day-item.active { background: var(--serenity); color: white; font-weight: bold; }
        .day-item.active span { color: white; }
        
        .diary-paper { background: #fff; background-image: linear-gradient(#f9f9f9 1px, transparent 1px); background-size: 100% 2.5rem; line-height: 2.5rem; padding: 1.5rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; margin-bottom: 20px; }
        .diary-paper::before { content: ''; position: absolute; left: 25px; top: 0; bottom: 0; width: 1.5px; background: rgba(247, 202, 201, 0.5); }
        .diary-content-text { margin-left: 25px; font-size: 0.95rem; color: #444; min-height: 5rem; white-space: pre-wrap; }
        
        .member-checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; background: #fdfdfd; padding: 12px; border-radius: 12px; border: 1px solid #eee; max-height: 160px; overflow-y: auto; }
        .member-tag { font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; border: 1px solid var(--serenity); color: var(--serenity); cursor: pointer; }
        .member-tag.active { background: var(--serenity); color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <input type="file" id="member-pic-input" style="display:none;" accept="image/*">
    <input type="file" id="bg-trigger" style="display:none;" accept="image/*" onchange="handleImageUpload('bg')">
    <input type="file" id="av-trigger" style="display:none;" accept="image/*" onchange="handleImageUpload('avatar')">

    <div id="memberModal" class="member-detail-modal">
        <span class="float-end fs-2" onclick="closeMemberModal()" style="cursor:pointer;">&times;</span>
        <div class="d-flex align-items-center mt-4 mb-2">
            <div id="modal-member-avatar" class="modal-avatar"></div>
            <h3 id="modal-member-name" class="fw-bold m-0" style="color:var(--serenity)"></h3>
        </div>
        <hr>
        <div id="modal-content"></div>
    </div>

    <section id="page-profile" class="page-section active" style="padding:0;">
        <div id="prof-bg" class="profile-header" onclick="document.getElementById('bg-trigger').click()">
            <div class="profile-avatar-container" onclick="event.stopPropagation(); document.getElementById('av-trigger').click()">
                <div id="prof-avatar-content"><i class="fas fa-gem" style="color:var(--serenity); font-size:2rem;"></i></div>
            </div>
        </div>
        <div class="p-4 bg-white shadow-sm mb-3" style="padding-top: 50px !important;">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="d-flex align-items-center mb-1">
                        <h4 id="display-name" class="fw-bold m-0" style="color:var(--serenity)">Carat</h4>
                        <i class="fas fa-pen ms-2 text-muted" style="cursor:pointer; font-size: 0.9rem; opacity: 0.7;" onclick="toggleEdit()"></i>
                    </div>
                    <p id="display-status" class="text-muted small mb-0">say the name!</p>
                </div>
            </div>
            <div id="edit-fields" style="display:none;" class="mt-3 p-3 bg-light rounded">
                <input type="text" id="input-name" class="form-control form-control-sm mb-2" placeholder="æš±ç¨±">
                <input type="text" id="input-status" class="form-control form-control-sm mb-2" placeholder="ç‹€æ…‹æ¶ˆæ¯">
                <button class="btn btn-sm btn-svt w-100" onclick="saveProfileText()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
        <div class="px-3">
            <div class="section-header">æˆå“¡åˆ—è¡¨</div>
            <div id="member-ratings"></div>
        </div>
    </section>

    <section id="page-finance" class="page-section">
        <div class="section-header">è¿½æ˜Ÿè¨˜å¸³</div>
        <div class="svt-card">
            <label class="small text-muted mb-1">æ—¥æœŸ</label>
            <input type="date" id="fin-date" class="form-control mb-3">
            <label class="small text-muted mb-1">æˆå“¡</label>
            <div id="fin-member-multi" class="member-checkbox-group mb-3"></div>
            <label class="small text-muted mb-1">é¡åˆ¥</label>
            <select id="fin-category" class="form-select mb-3">
                <option>å°ˆè¼¯</option><option>å°å¡</option><option>å‘¨é‚Š</option><option>å…¶ä»–</option>
            </select>
            <label class="small text-muted mb-1">é‡‘é¡</label>
            <div class="input-group mb-3">
                <select id="fin-currency" class="form-select" style="max-width:90px;"><option value="TWD">å°å¹£</option><option value="KRW">éŸ“å…ƒ</option></select>
                <input type="number" id="fin-amt" class="form-control" placeholder="é‡‘é¡">
            </div>
            <button class="btn btn-svt" onclick="addFinance()">å„²å­˜æ”¯å‡º</button>
        </div>
        <div id="list-finance"></div>
    </section>

    <section id="page-diary" class="page-section">
        <div class="calendar-nav">
            <div class="cal-header">
                <i class="fas fa-chevron-left" style="color:var(--serenity); cursor:pointer" onclick="changeWeek(-1)"></i>
                <div class="cal-month" id="cal-month-display"></div>
                <i class="fas fa-chevron-right" style="color:var(--serenity); cursor:pointer" onclick="changeWeek(1)"></i>
            </div>
            <div class="week-table" id="week-table-display"></div>
        </div>
        <button id="add-diary-btn" class="btn btn-svt mb-3" onclick="toggleDiaryForm()"><i class="fas fa-plus"></i> æ–°å¢æ—¥è¨˜</button>
        <div id="diary-form-container" class="svt-card" style="display:none;">
            <textarea id="diary-content" class="form-control mb-3" rows="3" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ"></textarea>
            <button class="btn btn-svt" onclick="saveDiary()">å„²å­˜ç´€éŒ„</button>
        </div>
        <div id="daily-merged-content"></div>
    </section>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="showPage('finance')"><i class="fas fa-wallet"></i><br>è¨˜å¸³</div>
        <div class="nav-item active nav-center" onclick="showPage('profile')">
            <div class="nav-center-circle"><i class="fas fa-gem" style="font-size:1.5rem;"></i></div>
            <span>ä¸»é </span>
        </div>
        <div class="nav-item" onclick="showPage('diary')"><i class="fas fa-book"></i><br>æ—¥è¨˜</div>
    </nav>
</div>

<script>
    const members = ["S.COUPS", "JEONGHAN", "JOSHUA", "JUN", "HOSHI", "WONWOO", "WOOZI", "THE 8", "MINGYU", "DK", "SEUNGKWAN", "VERNON", "DINO"];
    const KEY_PREFIX = 'SVT_V28_SYNC';
    const db = {
        get: (key, def) => JSON.parse(localStorage.getItem(`${KEY_PREFIX}_${key}`)) || def,
        set: (key, val) => localStorage.setItem(`${KEY_PREFIX}_${key}`, JSON.stringify(val))
    };

    let selectedDate = new Date().toISOString().split('T')[0];
    let currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
    let targetMember = "";

    function init() {
        const tagHTML = members.map(m => `<span class="member-tag" onclick="this.classList.toggle('active')">${m}</span>`).join('');
        document.getElementById('fin-member-multi').innerHTML = tagHTML;
        document.getElementById('fin-date').value = selectedDate;
        renderWeekTable();
        renderDiaryContent();
        renderProfile();
        renderFinance();
    }

    // --- æˆå“¡è©³ç´°è³‡æ–™é‚è¼¯ (å·²åŠ å…¥é ­åƒåŒæ­¥) ---
    function openMemberModal(name) {
        const finList = db.get('fin_list', []).filter(i => i.members.includes(name));
        const diaryData = db.get('diary_list', {});
        const pics = db.get('member_pics', {});
        
        const diaries = Object.keys(diaryData)
            .filter(date => diaryData[date].content.includes(name))
            .map(date => ({ date, content: diaryData[date].content }));

        // è¨­å®šå½ˆçª—å§“åèˆ‡åŒæ­¥é ­è²¼
        document.getElementById('modal-member-name').innerText = name;
        const modalAv = document.getElementById('modal-member-avatar');
        modalAv.innerHTML = pics[name] ? `<img src="${pics[name]}" style="width:100%; height:100%; object-fit:cover;">` : `<i class="fas fa-gem"></i>`;

        let html = `<p class="small text-muted">èˆ‡ ${name} ç›¸é—œçš„å½™ç¸½ç´€éŒ„ï¼š</p>`;
        
        html += `<div class="fw-bold mt-3 mb-2" style="color:var(--serenity)">ğŸ’° æ”¯å‡ºç´€éŒ„</div>`;
        html += finList.length ? finList.map(f => `
            <div class="sync-fin-item d-flex justify-content-between">
                <span>${f.date} (${f.category})</span>
                <span>${f.currency} ${f.amt}</span>
            </div>`).join('') : '<p class="small text-muted">æš«ç„¡æ”¯å‡ºç´€éŒ„</p>';

        html += `<div class="fw-bold mt-4 mb-2" style="color:var(--serenity)">âœï¸ æ—¥è¨˜æåŠ</div>`;
        html += diaries.length ? diaries.map(d => `
            <div class="p-2 bg-light rounded mb-2 small">
                <b style="color:var(--serenity)">${d.date}</b><br>${d.content}
            </div>`).join('') : '<p class="small text-muted">å°šæœªåœ¨æ—¥è¨˜ä¸­æåˆ°ä»–</p>';

        document.getElementById('modal-content').innerHTML = html;
        document.getElementById('memberModal').style.display = 'block';
    }

    function closeMemberModal() { document.getElementById('memberModal').style.display = 'none'; }

    // --- å…¶ä»–é‚è¼¯ä¿æŒåŸæ¨£ ---
    function addFinance() {
        const date = document.getElementById('fin-date').value;
        const amt = document.getElementById('fin-amt').value;
        const category = document.getElementById('fin-category').value;
        const currency = document.getElementById('fin-currency').value;
        const tags = Array.from(document.querySelectorAll('#fin-member-multi .member-tag.active')).map(el => el.innerText);
        if(!amt || tags.length === 0) return alert('è³‡è¨Šä¸å®Œæ•´');
        let list = db.get('fin_list', []);
        list.unshift({ id: Date.now(), date, members: tags, amt, currency, category });
        db.set('fin_list', list);
        let diaries = db.get('diary_list', {});
        const expenseNote = `\n[è‡ªå‹•è¨˜å¸³] ${category}: ${currency} ${amt} (${tags.join(', ')})`;
        if (diaries[date]) { diaries[date].content += expenseNote; } 
        else { diaries[date] = { content: `ä»Šæ—¥æ”¯å‡ºï¼š${expenseNote}`, members: tags, img: "" }; }
        db.set('diary_list', diaries);
        alert('è¨˜å¸³æˆåŠŸï¼'); renderFinance(); renderDiaryContent();
    }

    function renderFinance() {
        const list = db.get('fin_list', []);
        document.getElementById('list-finance').innerHTML = list.map(i => `
            <div class="svt-card d-flex justify-content-between align-items-center">
                <div><div class="small text-muted">${i.date} Â· ${i.category}</div><div class="fw-bold" style="color:var(--serenity)">${i.members.join(', ')}</div></div>
                <div class="fw-bold">${i.currency} ${i.amt}</div>
            </div>`).join('');
    }

    function renderDiaryContent() {
        const diaries = db.get('diary_list', {});
        const data = diaries[selectedDate];
        const display = document.getElementById('daily-merged-content');
        display.innerHTML = data ? `<div class="diary-paper"><div class="diary-content-text">${data.content}</div></div>` : `<div class="text-center p-5 text-white">é€™å¤©æ²’æœ‰æ—¥è¨˜å‘¢ ğŸ’</div>`;
    }

    function saveDiary() {
        const content = document.getElementById('diary-content').value;
        if(!content) return;
        let diaries = db.get('diary_list', {});
        diaries[selectedDate] = diaries[selectedDate] || { content: "", members: [], img: "" };
        diaries[selectedDate].content = content;
        db.set('diary_list', diaries);
        document.getElementById('diary-content').value = "";
        toggleDiaryForm(); renderDiaryContent();
    }

    function renderProfile() {
        const prof = db.get('profile', { name: "Carat", status: "Say the name!", avatar: "", bg: "" });
        const ratings = db.get('ratings', {});
        const pics = db.get('member_pics', {});
        document.getElementById('display-name').innerText = prof.name;
        document.getElementById('display-status').innerText = prof.status;
        if(prof.avatar) document.getElementById('prof-avatar-content').innerHTML = `<img src="${prof.avatar}">`;
        if(prof.bg) document.getElementById('prof-bg').style.backgroundImage = `url(${prof.bg})`;

        document.getElementById('member-ratings').innerHTML = members.map(m => `
            <div class="svt-card d-flex align-items-center justify-content-between py-2">
                <div class="d-flex align-items-center">
                    <div class="member-avatar-sm" onclick="triggerMemberPic('${m}')">
                        ${pics[m] ? `<img src="${pics[m]}">` : `<i class="fas fa-gem"></i>`}
                    </div>
                    <span class="fw-bold" style="color:var(--serenity); cursor:pointer;" onclick="openMemberModal('${m}')">${m}</span>
                </div>
                <div class="d-flex align-items-center">
                    ${[1,2,3,4,5].map(n => `<i class="fas fa-gem gem-rating ${(ratings[m]||0) >= n ? 'active' : ''}" onclick="updateRate('${m}', ${n})"></i>`).join('')}
                    <i class="fas fa-sync-alt reset-btn" onclick="updateRate('${m}', 0)"></i>
                </div>
            </div>`).join('');
    }

    function updateRate(m, s) { const r = db.get('ratings', {}); r[m] = s; db.set('ratings', r); renderProfile(); }
    
    function toggleEdit() { 
        const f = document.getElementById('edit-fields'); 
        const isOpening = f.style.display === 'none';
        f.style.display = isOpening ? 'block' : 'none'; 
        if(isOpening) {
            document.getElementById('input-name').value = document.getElementById('display-name').innerText;
            document.getElementById('input-status').value = document.getElementById('display-status').innerText;
        }
    }

    function saveProfileText() {
        const prof = db.get('profile', {});
        prof.name = document.getElementById('input-name').value || "Carat";
        prof.status = document.getElementById('input-status').value || "Say the name!";
        db.set('profile', prof); renderProfile(); toggleEdit();
    }

    function handleImageUpload(type) {
        const file = document.getElementById(type==='bg'?'bg-trigger':'av-trigger').files[0];
        const reader = new FileReader();
        reader.onload = e => { const prof=db.get('profile',{}); prof[type]=e.target.result; db.set('profile',prof); renderProfile(); };
        if(file) reader.readAsDataURL(file);
    }

    function triggerMemberPic(m) { targetMember = m; document.getElementById('member-pic-input').click(); }
    document.getElementById('member-pic-input').onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => { const pics=db.get('member_pics', {}); pics[targetMember]=ev.target.result; db.set('member_pics',pics); renderProfile(); };
        if(file) reader.readAsDataURL(file);
    };

    function renderWeekTable() {
        const table = document.getElementById('week-table-display');
        table.innerHTML = "";
        const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const tempDate = new Date(currentWeekStart);
        for (let i = 0; i < 7; i++) {
            const dateStr = tempDate.toISOString().split('T')[0];
            table.innerHTML += `<div class="day-item ${dateStr === selectedDate ? 'active' : ''}" onclick="selectedDate='${dateStr}';renderWeekTable();renderDiaryContent();"><span>${days[i]}</span>${tempDate.getDate()}</div>`;
            tempDate.setDate(tempDate.getDate() + 1);
        }
        document.getElementById('cal-month-display').innerText = `${currentWeekStart.getFullYear()}/${currentWeekStart.getMonth()+1}`;
    }
    function changeWeek(dir) { currentWeekStart.setDate(currentWeekStart.getDate() + (dir*7)); renderWeekTable(); }
    function toggleDiaryForm() { const c = document.getElementById('diary-form-container'); c.style.display = c.style.display === 'none' ? 'block' : 'none'; }
    function showPage(id) {
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navIdx = { 'finance': 1, 'profile': 2, 'diary': 3 };
        document.querySelector(`.nav-item:nth-child(${navIdx[id]})`).classList.add('active');
        window.scrollTo(0,0);
    }

    window.onload = init;
</script>
</body>
</html>
